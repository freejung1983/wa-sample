# WA 3.0 — 상세 기획서 (RO·알림·서비스 플로우) v1

작성일: 2025-08-11\
버전: v1\
작성자: 윤효정 / 협업: ChatGPT

---

## 1) RO 상태 모델(확장)

비즈니스 상위 단계(Phase)와 내부 운용 상세(Status Detail)를 분리하여, 단순 보고는 Phase를, 실행/자동화를 위한 제어는 Status Detail을 사용한다.

### 1.1 상위 Phase (보고용)

- **PreRO**: RO 생성 전, 고객 컨펌 대기/상담 단계 (DMS 미등록)
- **Created**: 고객 컨펌 완료, RO가 생성되어 DMS 번호 부여됨
- **Completed**: 수리 완료 후 FI(Final Inspection) **Pass**
- **Delivery**: 고객에게 차량 **전달 완료(Delivered)**

---

## 2) 알림(Notifications) & RO 메시지(채팅)

### 2.1 채널

- **In-app Notification**: 실시간 알림 센터 + 배지, 웹소켓 기반
- **Email**: 중요 이벤트(고객 컨펌 요청, 추가 항목 승인 요청, 출고 준비 등) 발송

### 2.2 이벤트 → 수신자 매트릭스

| 이벤트                     | 채널                | 수신자        | 내용/행동                      |
| ----------------------- | ----------------- | ---------- | -------------------------- |
| PreRO 생성                | In-app            | SA, CT     | 신규 상담 건 등록 알림              |
| 고객 컨펌 요청 발송             | Email, In-app     | 고객, SA     | 승인 링크/요약 내역                |
| RO Created              | In-app            | CT         | 배정 필요 알림                   |
| Assign 완료               | In-app            | TC, SA     | 작업자/시작 가능 알림               |
| Repair Start/Pause/Done | In-app            | CT, SA     | 진행/일시중지/완료 상태              |
| 추가항목 제안                 | Email, In-app     | 고객, SA     | 승인/거절 버튼 포함                |
| 추가항목 승인/거절/취소           | In-app            | SA, TC, CT | 작업목록/견적 갱신                 |
| FI Pass/Fail            | In-app            | SA, CT, TC | Pass: 출고 준비 / Fail: 재작업 필요 |
| Ready for Delivery      | Email, In-app     | 고객, SA     | 인도 예약/안내                   |
| Delivered               | In-app, Email(옵션) | 고객, SA     | 인도 완료/영수내역                 |
| 설문 요청                   | Email             | 고객         | 만족도 조사 링크                  |

### 2.3 RO 메시지(채팅) 스펙

- **범위**: RO 단위 스레드(각 RO에 1채팅방), 역할별 멘션(@SA/@CT/@TC/@FI/@고객)
- **메시지 유형**: 사용자 메시지 / 시스템 이벤트(상태 변경, 배정 등)
- **권한**: 내부자(SA,CT,TC,FI) 쓰기/읽기, 고객은 링크 기반 읽기/승인 응답만(옵션)
- **기능**: 첨부(사진/영상/음성), 읽음표시, 고정(Pin), 시스템 요약 카드(추가항목·견적)
- **보존**: RO 종료 후 1년(정책 가변)

---

## 3) 서비스 단계 설계

### 3.1 Pre-service: Appointment

- **예약 있음**: DMS 예약 조회→WA에 동기화(읽기 전용), RO 생성 시 해당 예약 참조
- **워크인**: WA에서 예약 생성 불가(정책). 고객 조회→미존재 시 신규 등록, RO는 **PreRO**로 시작. RO가 **Created** 되면 DMS 번호 발급/연결
- **필수 수집 항목**: Today No(연락번호), 주행거리, 예정 인도일, SA 이름, 고객 요청사항(음성/메모/사진/영상)

### 3.2 Service: Consulting (SA VHC)

- 고객과 차량 **Walk Around** 수행 → 이상 부위/요청사항 캡처(사진/영상/음성/텍스트)
- 상태: `PRE_CONSULT → PRE_READY_FOR_CONFIRM` 전환
- 고객 컨펌 완료 시 `RO_CREATED` 로 전환 및 DMS 연동

### 3.3 Service: Repair (TC VHC)

- 배정 후 TC 작업: `REPAIR_START/PAUSE/DONE` 트래킹 → **LTS**(작업 평균 시간) 산출
- **추가 결함** 발견 시 **Additional Item** 제안 절차:
  1. TC/SA가 상세에서 항목 추가(부품/공임/사진 포함)
  2. 상태 `ADDITIONAL_PENDING` → 고객에게 승인 요청(알림/이메일)
  3. 고객 응답에 따라 `ACCEPTED`/`DECLINED`/`CANCELLED`
  
  - **Additional Item**
  | Item Type               | Description                      |
  | ----------------------- | -------------------------- |
  | TEXT                    | 고객이나 SA/TC가 직접 남기는 수리 사항 (예: "엔진 소리가 좋지 않다")  |
  | PERIOD_MAINTENANCE      | 주행거리/기간 조건 충족 시 제공되는 무상 수리 (예: 정기검사)          |
  | PART                    | 부품별 정가 (예: Door, Tire)                                       |
  | PACKAGE                 | OP + Part를 묶은 패키지 가격                                       |
  | OP                      | Operation / Labor — DMS에 책정된 가격, 기술단가 포함 (예: 엔진 수리) |
  | MANUAL_OP               | DMS에 등록되지 않은 작업(수동 입력)                                 |

  - **Declined**: 이력 보존(보고/분석 반영)
  - **Cancelled**: UI 이력 미표시(오입력 정정용), 내부 감사로그만(옵션)

### 3.4 Service: FI VHC

- CT가 `RO Done` 처리 시 **FI 배정** → 상태 `FI_CHECK`
- **Fail**: 원인 및 항목 지정 후 `REPAIR_START`로 되돌림(재작업)
- **Pass**: 상태 `FI_PASS` → **Phase=Completed** → `READY_FOR_DELIVERY`

### 3.5 Delivery (SA)

- 결제(외부), 서류, 세차 체크 완료 시 `DELIVERED` 처리(인수 확인)
- 고객 이메일/인앱으로 인도 내역 요약 발송

### 3.6 Post-service

- **Survey**: 현재 WA 내장(내부 입력) → 고객용 설문 링크 제공 필요(향후)

---

## 4) 시나리오 ↔ 상태/역할 맵핑

1. **DMS 고객 조회** → PreRO 생성(`PRE_CONSULT`)
2. PreRO 정보 입력(연락처/주행거리/예정일/요청사항/SA 이름 등)
3. **SA VHC** 완료 → 고객 컨펌 요청(`PRE_READY_FOR_CONFIRM`)
4. 고객 컨펌 → **RO Created**(`RO_CREATED`, DMS No. 부여)
5. **CT 배정** → `ASSIGNED`
6. **TC 작업** 시작/일시중지/완료(`REPAIR_START/PAUSE/DONE`), LTS 기록
7. 추가항목 발견 시 `ADDITIONAL_PENDING` → 고객 응답에 따라 반영
8. **CT RO Done** → **FI 배정**(`FI_CHECK`)
9. **FI Pass/Fail** → Pass 시 `FI_PASS` → `READY_FOR_DELIVERY`
10. **결제/인도** → `DELIVERED`(Phase=Delivery) → 설문 발송

---

## 5) 권한·검증 정책

- **PreRO**: SA만 생성/수정, 고객은 승인만 가능(링크)
- **Assign/Repair**: CT가 배정, TC는 자기 작업만 변경 가능
- **Additional Item**: TC/SA 생성, 고객이 승인/거절, SA/TC가 취소 가능(내부 감사 로그)
- **FI**: FI 담당자만 Pass/Fail
- **Delivery**: SA만 인도 처리(이중 확인)

입력 검증 예시: Today No 필수, 주행거리(정수/상한), 예정인도일(영업일), 미디어 용량 제한 등

---

## 6) 지표/KPI 수집

- **LTS**: 작업코드별 p50/p90 작업시간, 모델/연식별 세분화
- **Additional Item 전환율**: 제안→승인 비율, Declined 사유 택일
- **FI 재작업률**: Fail 비율/원인 분포
- **인도 리드타임**: FI Pass→Delivered 소요

---

## 7) JS Report 생성 스펙
- **트리거**: **Completed(=FI Pass 이후)** 시점에 RO 상세 화면의 **“JS Report 생성”** 버튼 클릭 시 생성.
- **구성요소**: **Template / Template Engine / Data / Recipe(출력 방식)**
  - *Template*: 보고서 레이아웃(헤더/푸터/바디) 버전 관리
  - *Engine*: 예) Handlebars, EJS 등
  - *Data*: RO, VHC, AdditionalItem, 금액 합계/세금, 고객·차량 정보, 타임라인
  - *Recipe*: PDF/HTML/XLSX 중 선택 (브라우저 렌더 기반 PDF 권장)
- **흐름**:
  1) 사용자가 버튼 클릭 → `POST /api/ros/{id}/reports/js` (template_id, recipe, locale)
  2) 서버가 `ReportJob(PENDING→RUNNING)` 생성 → 렌더링 → DONE 시 `output_url` 발급
  3) 완료 알림(In-app, 실패 시 에러 알림) → 다운로드/미리보기
- **권한**: SA/CT/FI 생성 가능(권장: SA 중심). 고객 링크 공유는 별도 권한/서명 토큰 필요
- **보안**: output은 만료 URL(예: 7일), 접근 로그, 워터마크 옵션(예: RO No., 생성시각)
- **버전관리**: `ReportTemplate.version`으로 회귀 가능. 템플릿 변경은 관리자 권한
- **알림 이벤트(추가)**: `ReportJob.DONE` / `ReportJob.FAILED`

---

## 8) 라운지 키오스크(KIOSK) — 지역별 정책
- **적용 지역**: 현재 **인도(IN), 터키(TR)**만 사용(테넌트 플래그로 제어)
- **공통 기능**: RO 진행 현황, 고객용 미디어(사진/영상) 열람, 대기번호, 주의/안전 고지
- **인도(IN)**: **미디어 중심** — Pre-service/Repair 과정의 사진·영상 갤러리 위주 노출
- **터키(TR)**: **진행 현황 표(Table)** — 단계/담당/시작시각/예상완료를 테이블로 실시간 표시
- **보안/개인정보**: 부분 마스킹(RO No./VIN/전화), **OTP(오늘 연락처) 검증** 후 상세 노출, 세션 타임아웃
- **오프라인 모드**: 최신 스냅샷 캐시 후 네트워크 복구 시 동기화
- **접근 경로**: 대기표 QR → `public_token` 기반 조회(쓰기 금지)

### 8.1 키오스크 화면(요약)
- 헤더(센터명·대기번호), 진행 단계 바, 미디어 갤러리(IN), 현황표(TR), 개인정보 고지/동의

---

## 9) GSW 연계(테크니션 교육 컨텐츠)
- **목적**: 정비사(Technician)가 작업 전/중 관련 교육 자료(매뉴얼/동영상/퀵가이드)를 즉시 열람
- **연계 방식**: 외부 GSW 콘텐츠 링크/딥링크 저장(`TrainingContent.url`), 싱글사인온(SSO) 또는 토큰 전달(정책 확정 필요)
- **추천 로직(옵션)**: RO 항목(labor_code/part_no)과 매핑하여 관련 콘텐츠 자동 추천
- **할당/이수**: `TrainingAssignment`로 특정 TC에게 과제 할당, 이수 체크(수동/웹훅)
- **오프라인**: 주요 문서는 사전 캐시(저작권 정책 확인)

